<!-- public/signin.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .auth-container {
      max-width: 450px;
      margin: 80px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .form-title {
      text-align: center;
      margin-bottom: 25px;
      color: #333;
    }
    .form-control:focus {
      border-color: #6c757d;
      box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25);
    }
    .btn-primary {
      background-color: #0d6efd;
      border: none;
      width: 100%;
      padding: 10px;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
    }
    .alert {
      display: none;
      margin-bottom: 20px;
    }
    .timer {
      font-size: 14px;
      color: #6c757d;
      text-align: center;
      margin-top: 10px;
      display: none;
    }
    #otpSection {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="auth-container">
      <h2 class="form-title">Sign In</h2>
      
      <div class="alert alert-danger" id="errorAlert" role="alert"></div>
      <div class="alert alert-success" id="successAlert" role="alert"></div>
      
      <!-- Email Form -->
      <form id="emailForm">
        <div class="mb-3">
          <label for="email" class="form-label">Email address</label>
          <input type="email" class="form-control" id="email" required>
          <div class="form-text">We'll send a one-time password to this email.</div>
        </div>
        <button type="submit" class="btn btn-primary">Request OTP</button>
        <div class="timer" id="cooldownTimer">Please wait <span id="timeLeft">0</span> before requesting a new OTP</div>
      </form>
      
      <!-- OTP Verification Form -->
      <form id="otpSection">
        <div class="mb-3">
          <label for="otp" class="form-label">Enter OTP</label>
          <input type="text" class="form-control" id="otp" required pattern="[0-9]{6}" maxlength="6">
          <div class="form-text">Enter the 6-digit code sent to your email.</div>
        </div>
        <button type="submit" class="btn btn-primary">Verify</button>
        <div class="timer" id="expiryTimer">OTP expires in <span id="expiryTimeLeft">10:00</span></div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const emailForm = document.getElementById('emailForm');
      const otpSection = document.getElementById('otpSection');
      const errorAlert = document.getElementById('errorAlert');
      const successAlert = document.getElementById('successAlert');
      const cooldownTimer = document.getElementById('cooldownTimer');
      const expiryTimer = document.getElementById('expiryTimer');
      const emailInput = document.getElementById('email');
      
      let expiryInterval;
      let cooldownInterval;
      
      // Email form submission
      emailForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        hideAlerts();
        const email = emailInput.value.trim();
        
        if (!email) {
          showError('Please enter your email address');
          return;
        }
        
        try {
          const response = await fetch('/user/request-otp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            if (response.status === 429) {
              // Handle rate limiting (cooldown period)
              const match = data.message.match(/Please wait (\d+) minute/);
              if (match && match[1]) {
                startCooldownTimer(parseInt(match[1]));
              }
            }
            throw new Error(data.message || 'Failed to request OTP');
          }
          
          // Show OTP section on success
          showSuccess(data.message);
          otpSection.style.display = 'block';
          startExpiryTimer();
          
          // Focus on OTP input
          document.getElementById('otp').focus();
          
        } catch (error) {
          showError(error.message);
        }
      });
      
      // OTP form submission
      otpSection.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        hideAlerts();
        const email = emailInput.value.trim();
        const otp = document.getElementById('otp').value.trim();
        
        if (!otp) {
          showError('Please enter the OTP sent to your email');
          return;
        }
        
        try {
          const response = await fetch('/user/verify-otp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, otp })
          });
          
          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.message || 'Invalid OTP');
          }
          
          // If successful, the controller will redirect to home page
          // No need to handle response here
          clearInterval(expiryInterval);
          
          // Redirect will happen automatically from the server
          // But in case it doesn't, we can force a redirect after a short delay
          setTimeout(() => {
            window.location.href = '/';
          }, 500);
          
        } catch (error) {
          showError(error.message);
        }
      });
      
      // Helper functions
      function showError(message) {
        errorAlert.textContent = message;
        errorAlert.style.display = 'block';
      }
      
      function showSuccess(message) {
        successAlert.textContent = message;
        successAlert.style.display = 'block';
      }
      
      function hideAlerts() {
        errorAlert.style.display = 'none';
        successAlert.style.display = 'none';
      }
      
      function startExpiryTimer() {
        clearInterval(expiryInterval);
        let timeLeft = 10 * 60; // 10 minutes in seconds
        expiryTimer.style.display = 'block';
        
        function updateExpiryTimer() {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          document.getElementById('expiryTimeLeft').textContent = 
            `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
          
          if (timeLeft <= 0) {
            clearInterval(expiryInterval);
            showError('OTP has expired. Please request a new one.');
            otpSection.style.display = 'none';
            expiryTimer.style.display = 'none';
          }
          timeLeft--;
        }
        
        updateExpiryTimer();
        expiryInterval = setInterval(updateExpiryTimer, 1000);
      }
      
      function startCooldownTimer(minutes) {
        clearInterval(cooldownInterval);
        let timeLeft = minutes * 60; // Convert minutes to seconds
        cooldownTimer.style.display = 'block';
        
        function updateCooldownTimer() {
          const mins = Math.floor(timeLeft / 60);
          const secs = timeLeft % 60;
          document.getElementById('timeLeft').textContent = 
            `${mins}:${secs < 10 ? '0' + secs : secs}`;
          
          if (timeLeft <= 0) {
            clearInterval(cooldownInterval);
            cooldownTimer.style.display = 'none';
          }
          timeLeft--;
        }
        
        updateCooldownTimer();
        cooldownInterval = setInterval(updateCooldownTimer, 1000);
      }
    });
  </script>
</body>
</html>
